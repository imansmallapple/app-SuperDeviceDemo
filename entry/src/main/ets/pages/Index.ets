import DeviceManager from '../utils/DeviceManager'
import DeviceListDialog from '../view/CustomDialogComponent';
import { distributedDeviceManager } from '@kit.DistributedServiceKit';
import Log from '../utils/Log';
import { common } from '@kit.AbilityKit';
import KvStoreModel from '../utils/kvStoreUtil';
// import { distributedKVStore } from '@kit.ArkData';
import distributedKVStore from '@ohos.data.distributedKVStore';

// Ê∂àÊÅØÊé•Âè£ÂÆö‰πâ
interface ChatMessage {
  content: string
  isSent: boolean  // true=Ëá™Â∑±ÂèëÁöÑ, false=ÂØπÊñπÂèëÁöÑ
  timestamp: number
}

@Entry
@Component
struct Index {
  @StorageLink('deviceList') deviceList: distributedDeviceManager.DeviceBasicInfo[] = []
  @StorageLink('RemoteConnectDeviceId') remoteConnectDeviceId: string = ''
  @StorageLink('isSender') isSender: boolean = false
  @StorageLink('isReceiver') isReceiver: boolean = false
  @StorageLink('isPaired') isPaired: boolean = false
  @LocalStorageProp('messageList') messageList: string[] = [];
  @State connectedDeviceId: string = ''
  @State textInput: string = ''
  @State receivedText: string[] = []
  @State isLoading: boolean = false
  @State isAbleUnbind: boolean = false
  private context: common.UIAbilityContext = this.getUIContext().getHostContext() as common.UIAbilityContext;
  private kvStoreModel: KvStoreModel = new KvStoreModel();
  @State receivedList: string[] = []
  @State allMessages: ChatMessage[] = []  // ÂêàÂπ∂ÁöÑÊ∂àÊÅØÂàóË°®ÔºåÊåâÊó∂Èó¥ÊéíÂ∫è
  private scroller: Scroller = new Scroller()  // ÊªöÂä®ÊéßÂà∂Âô®
  @State isSyncing: boolean = false  // ÂêåÊ≠•Áä∂ÊÄÅ
  private lastReceivedCount: number = 0  // Ë∑üË∏™‰∏äÊ¨°Â§ÑÁêÜÁöÑÊé•Êî∂Ê∂àÊÅØÊï∞Èáè
  private syncTimer: number = -1  // Áî®‰∫éÈò≤ÊäñÁöÑÂÆöÊó∂Âô®
  private pollTimer: number = -1  // ‰∏ªÂä®ËΩÆËØ¢ÂÆöÊó∂Âô® - ÊØè2ÁßíÊãâÂèñ‰∏ÄÊ¨°Êï∞ÊçÆ
  storage: LocalStorage | undefined = this.getUIContext().getSharedLocalStorage()

  aboutToAppear() {
    Log.info('Index', '========== aboutToAppear START ==========')
    Log.info('Index', 'aboutToAppear - isSender:', this.isSender, 'isReceiver:', this.isReceiver)
    Log.info('Index', 'aboutToAppear - remoteConnectDeviceId:', this.remoteConnectDeviceId)
    
    this.createKVStore()
    
    // Ê∏ÖÁ©∫Êú¨Âú∞Áä∂ÊÄÅÔºåÁ°Æ‰øù‰ªéÂπ≤ÂáÄÁä∂ÊÄÅÂºÄÂßã
    this.messageList = []
    this.receivedList = []
    this.allMessages = []
    this.lastReceivedCount = 0
    Log.info('Index', '‚úÖ Cleared all local message state')
    
    // Ê∏ÖÁ©∫ KVStore ‰∏≠ÁöÑÊóßÊï∞ÊçÆÔºàÂª∂ËøüÊâßË°åÔºåÁ≠âÂæÖ KVStore ÂàùÂßãÂåñÂÆåÊàêÔºâ
    setTimeout(() => {
      Log.info('Index', 'üßπ Cleaning old KVStore data...')
      this.kvStoreModel.delete('messages_sender', (success) => {
        Log.info('Index', `Delete messages_sender: ${success}`)
      })
      this.kvStoreModel.delete('messages_receiver', (success) => {
        Log.info('Index', `Delete messages_receiver: ${success}`)
      })
    }, 500)
    
    // ÂêØÂä®‰∏ªÂä®ËΩÆËØ¢Êú∫Âà∂ - ÊØè2ÁßíÊãâÂèñ‰∏ÄÊ¨°Êï∞ÊçÆ
    this.startPolling()
    
    // ÂàùÂßãÂåñÊó∂‰∏çÈúÄË¶ÅË∞ÉÁî®updateAllMessagesÔºåÂõ†‰∏∫ËøòÊ≤°ÊúâÊ∂àÊÅØ
    // updateAllMessagesÂè™Âú®Êé•Êî∂Âà∞Êñ∞Ê∂àÊÅØÊó∂Ë∞ÉÁî®
    
    // Âè™ÊúâÂèëÈÄÅÁ´ØÊâçÊ∏ÖÁ©∫ËÆæÂ§áÂàóË°®,Êé•Êî∂Á´Ø‰∏çÈúÄË¶Å
    if (!this.isReceiver) {
      DeviceManager.clearDeviceList()
    }
    
    // Â¶ÇÊûúÊòØÊé•Êî∂Á´ØÔºåËÆ∞ÂΩïÊó•Âøó
    if (this.isReceiver) {
      Log.info('Index', 'This is receiver side, waiting for messages...')
    }
    
    Log.info('Index', '========== aboutToAppear END ==========')
  }

  // ÂêØÂä®‰∏ªÂä®ËΩÆËØ¢Êú∫Âà∂
  private startPolling(): void {
    Log.info('Index', 'üîÑ Starting polling mechanism...')
    
    // Ê∏ÖÈô§ÊóßÁöÑÂÆöÊó∂Âô®
    if (this.pollTimer !== -1) {
      clearInterval(this.pollTimer)
    }
    
    // ÊØè2Áßí‰∏ªÂä®ÊãâÂèñ‰∏ÄÊ¨°Êï∞ÊçÆÔºà‰ªÖÂú®Â∑≤ËøûÊé•Êó∂Ôºâ
    this.pollTimer = setInterval(() => {
      // Âè™Âú®Â∑≤ËøûÊé•ËøúÁ´ØËÆæÂ§áÊó∂ÊâçÂêåÊ≠•
      if (this.remoteConnectDeviceId && this.remoteConnectDeviceId.length > 0) {
        Log.info('Index', 'üì° Polling: Manually triggering sync to', this.remoteConnectDeviceId)
        this.kvStoreModel.manualPullSync(this.remoteConnectDeviceId)
      } else {
        Log.info('Index', '‚è∏Ô∏è Polling: No remote device connected, skipping sync')
      }
    }, 2000)
    
    Log.info('Index', '‚úÖ Polling started with 2s interval')
  }

  // ÂÅúÊ≠¢ËΩÆËØ¢
  private stopPolling(): void {
    if (this.pollTimer !== -1) {
      clearInterval(this.pollTimer)
      this.pollTimer = -1
      Log.info('Index', '‚úÖ Polling stopped')
    }
  }

  createKVStore(): void {
    Log.info('Index', '========== createKVStore START ==========')
    Log.info('Index', 'isSender:', this.isSender)
    Log.info('Index', 'isReceiver:', this.isReceiver)
    Log.info('Index', 'remoteConnectDeviceId:', this.remoteConnectDeviceId)
    
    this.kvStoreModel.createKvStore(this.context, (data: distributedKVStore.ChangeNotification) => {
      Log.info('kvStore', '==========================================')
      Log.info('kvStore', 'dataChange event received!')
      Log.info('kvStore', 'deviceId:', data.deviceId)
      Log.info('kvStore', 'insertEntries:', data.insertEntries.length)
      Log.info('kvStore', 'updateEntries:', data.updateEntries.length)
      Log.info('kvStore', 'deleteEntries:', data.deleteEntries.length)
      
      // ‰∏çÂÜçÁÆÄÂçïÂú∞ÂøΩÁï•Á©∫deviceIdÔºåËÄåÊòØÊ†πÊçÆkeyÂà§Êñ≠
      // Âõ†‰∏∫ËøúÁ®ãÂêåÊ≠•ÁöÑÊï∞ÊçÆÂú®Êú¨Âú∞‰πüÂèØËÉΩËß¶ÂèëÁ©∫deviceIdÁöÑ‰∫ã‰ª∂
      
      // Ëé∑ÂèñÂΩìÂâçËÆæÂ§áÁöÑËßíËâ≤Ê†áËØÜ
      let myRole: string
      let remoteRole: string
      
      // ‰ºòÂÖà‰ΩøÁî®ÊòéÁ°ÆÁöÑËßíËâ≤Ê†áËØÜ
      if (this.isReceiver) {
        // Ë¢´ËøúÁ®ãÂêØÂä®ÁöÑÊé•Êî∂Á´Ø
        myRole = 'receiver'
        remoteRole = 'sender'
        Log.info('kvStore', '‚úÖ Explicit receiver role (remote started)')
      } else if (this.isSender) {
        // ÊòéÁ°ÆÁöÑÂèëÈÄÅÁ´Ø
        myRole = 'sender'
        remoteRole = 'receiver'
        Log.info('kvStore', '‚úÖ Explicit sender role')
      } else {
        // Êú¨Âú∞ÂêØÂä®‰∏îËøòÊ≤°ÊòéÁ°ÆËßíËâ≤ÁöÑÊÉÖÂÜµ
        // Ê†πÊçÆÊòØÂê¶‰∏ªÂä®ËøûÊé•Êù•Êé®Êñ≠
        if (this.remoteConnectDeviceId && this.connectedDeviceId) {
          // ÊúâËøûÊé•IDÔºåËØ¥ÊòéÊòØ‰∏ªÂä®ÂèëËµ∑ËøûÊé•ÁöÑ‰∏ÄÊñπ
          myRole = 'sender'
          remoteRole = 'receiver'
          Log.info('kvStore', 'üîç No explicit role, inferring as sender (has connection)')
        } else {
          // Âê¶ÂàôÈªòËÆ§‰∏∫Êé•Êî∂Á´Ø
          myRole = 'receiver'
          remoteRole = 'sender'
          Log.info('kvStore', 'üîç No explicit role, defaulting to receiver')
        }
      }
      
      Log.info('kvStore', 'Current device role:', myRole)
      Log.info('kvStore', 'Expecting messages from role:', remoteRole)
      Log.info('kvStore', `Will process key: messages_${remoteRole}`)
      Log.info('kvStore', '------------------------------------------')
      
      // Â§ÑÁêÜÊèíÂÖ•ÁöÑÊï∞ÊçÆ
      if (data.insertEntries.length > 0) {
        data.insertEntries.forEach((entry) => {
          Log.info('kvStore', 'inside insert', entry.key, entry.value.type, entry.value.value)
          // Âè™Â§ÑÁêÜÂØπÊñπÂèëÈÄÅÁöÑÊ∂àÊÅØÔºàkey ÂåÖÂê´ÂØπÊñπÁöÑËßíËâ≤Ôºâ
          if (entry.key === `messages_${remoteRole}`) {
            Log.info('kvStore', `‚úÖ Processing remote message (key: ${entry.key})`)
            const value = JSON.parse((entry.value.value) as string) as string[]
            const oldLength = this.receivedList.length
            this.receivedList = value
            
            Log.info('kvStore', `receivedList changed from ${oldLength} to ${value.length} messages`)
            Log.info('kvStore', 'All received messages:', JSON.stringify(value))
            
            // Êõ¥Êñ∞ÂêàÂπ∂Ê∂àÊÅØÂàóË°®
            this.updateAllMessages()
            
            Log.info('kvStore', 'receivedList after insert:', this.receivedList)
            
            // ‰∏ªÂä®Ëß¶Âèë‰∏ÄÊ¨°ÂêåÊ≠•ÔºåÁ°Æ‰øùËÉΩÁªßÁª≠Êé•Êî∂ÂêéÁª≠Ê∂àÊÅØ
            // ‰ΩøÁî®Èò≤ÊäñÊú∫Âà∂ÈÅøÂÖçÁü≠Êó∂Èó¥ÂÜÖÂ§öÊ¨°syncÂÜ≤Á™Å
            const targetDeviceId = this.remoteConnectDeviceId || this.connectedDeviceId
            if (targetDeviceId) {
              // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
              if (this.syncTimer !== -1) {
                clearTimeout(this.syncTimer)
              }
              // ËÆæÁΩÆÊñ∞ÁöÑÂª∂ËøüsyncÔºà100msÈò≤ÊäñÔºâ
              this.syncTimer = setTimeout(() => {
                Log.info('kvStore', 'üîÑ Triggering sync after receiving message to ensure continuous updates')
                this.kvStoreModel.sync([targetDeviceId])
                this.syncTimer = -1
              }, 100)
            }
          } else {
            Log.info('kvStore', `‚è≠Ô∏è Skipping local message (key: ${entry.key}, expecting: messages_${remoteRole})`)
          }
        })
      }
      
      // Â§ÑÁêÜÊõ¥Êñ∞ÁöÑÊï∞ÊçÆ
      if (data.updateEntries.length > 0) {
        data.updateEntries.forEach((entry) => {
          Log.info('kvStore', 'inside update', entry.key, entry.value.type, entry.value.value)
          // Âè™Â§ÑÁêÜÂØπÊñπÂèëÈÄÅÁöÑÊ∂àÊÅØÔºàkey ÂåÖÂê´ÂØπÊñπÁöÑËßíËâ≤Ôºâ
          if (entry.key === `messages_${remoteRole}`) {
            Log.info('kvStore', `‚úÖ Processing remote message (key: ${entry.key})`)
            const value = JSON.parse((entry.value.value) as string) as string[]
            const oldLength = this.receivedList.length
            this.receivedList = value
            
            Log.info('kvStore', `receivedList changed from ${oldLength} to ${value.length} messages`)
            Log.info('kvStore', 'All received messages:', JSON.stringify(value))
            
            // Êõ¥Êñ∞ÂêàÂπ∂Ê∂àÊÅØÂàóË°®
            this.updateAllMessages()
            
            Log.info('kvStore', 'receivedList after update:', this.receivedList)
            
            // ‰∏ªÂä®Ëß¶Âèë‰∏ÄÊ¨°ÂêåÊ≠•ÔºåÁ°Æ‰øùËÉΩÁªßÁª≠Êé•Êî∂ÂêéÁª≠Ê∂àÊÅØ
            // ‰ΩøÁî®Èò≤ÊäñÊú∫Âà∂ÈÅøÂÖçÁü≠Êó∂Èó¥ÂÜÖÂ§öÊ¨°syncÂÜ≤Á™Å
            const targetDeviceId = this.remoteConnectDeviceId || this.connectedDeviceId
            if (targetDeviceId) {
              // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
              if (this.syncTimer !== -1) {
                clearTimeout(this.syncTimer)
              }
              // ËÆæÁΩÆÊñ∞ÁöÑÂª∂ËøüsyncÔºà100msÈò≤ÊäñÔºâ
              this.syncTimer = setTimeout(() => {
                Log.info('kvStore', 'üîÑ Triggering sync after receiving message to ensure continuous updates')
                this.kvStoreModel.sync([targetDeviceId])
                this.syncTimer = -1
              }, 100)
            }
          } else {
            Log.info('kvStore', `‚è≠Ô∏è Skipping local message (key: ${entry.key}, expecting: messages_${remoteRole})`)
          }
        })
      }
    })
    
    // Ê≥®ÂÜåÂêåÊ≠•ÂÆåÊàêÂõûË∞ÉÔºå‰∏ªÂä®ÊãâÂèñËøúÁ®ãÊï∞ÊçÆ
    this.kvStoreModel.onSyncComplete(() => {
      Log.info('Index', 'üîÑ syncComplete triggered - fetching remote data')
      
      // Á°ÆÂÆöËøúÁ®ãËÆæÂ§á‰ΩøÁî®ÁöÑkey
      let remoteKey: string
      if (this.isReceiver) {
        // Êé•Êî∂Á´ØÈúÄË¶ÅÊãâÂèñÂèëÈÄÅÁ´ØÁöÑÊï∞ÊçÆ
        remoteKey = 'messages_sender'
      } else {
        // ÂèëÈÄÅÁ´ØÈúÄË¶ÅÊãâÂèñÊé•Êî∂Á´ØÁöÑÊï∞ÊçÆ
        remoteKey = 'messages_receiver'
      }
      
      Log.info('Index', `üì• Fetching data with key: ${remoteKey}`)
      
      // ‰∏ªÂä®‰ªéKVStore‰∏≠Ëé∑ÂèñÊï∞ÊçÆ
      this.kvStoreModel.get(remoteKey, (value: string | undefined) => {
        if (value === undefined) {
          Log.info('Index', `‚ö†Ô∏è No data found for key: ${remoteKey}`)
          return
        }
        
        try {
          const messages = JSON.parse(value) as string[]
          Log.info('Index', `‚úÖ Fetched ${messages.length} messages from ${remoteKey}`)
          
          // Êõ¥Êñ∞Êé•Êî∂Âà∞ÁöÑÊ∂àÊÅØÂàóË°®
          const oldLength = this.receivedList.length
          this.receivedList = messages
          
          Log.info('Index', `üìä receivedList updated: ${oldLength} -> ${this.receivedList.length}`)
          
          // Êõ¥Êñ∞UI
          this.updateAllMessages()
        } catch (error) {
          Log.error('Index', `‚ùå Failed to parse messages: ${JSON.stringify(error)}`)
        }
      })
    })
  }

  aboutToDisappear(): void {
    Log.info('Index', 'üõë aboutToDisappear called - stopping polling')
    this.stopPolling()
    this.kvStoreModel.removeDataChangeListener()
  }

  private dialogController: CustomDialogController = new CustomDialogController({
    builder: DeviceListDialog({
      startAbility: this.startAbility,
      deviceList: this.deviceList,
      cancel: this.onCancel,
      param: this.messageList,
      connectedDeviceId: this.connectedDeviceId,
      isLoading: this.isLoading,
      isPaired: this.isPaired,
    })
  })

  // checkAbleUnbind() {
  //   if (this.connectDeviceId !== '') {
  //     this.isAbleUnbind = true
  //   } else {
  //     this.isAbleUnbind = false
  //   }
  // }
  startFindingNearbyDevice(): void {
    DeviceManager.startDeviceDiscovery()
  }

  onCancel(): void {
    DeviceManager.stopDeviceDiscovery()
  }

  pushData(data: string): void {
    Log.info('Index', '=== pushData called ===')
    Log.info('Index', 'isSyncing status:', this.isSyncing)
    
    if (this.isSyncing) {
      Log.info('Index', 'Still syncing previous message, please wait...');
      this.getUIContext().getPromptAction().showToast({
        message: "Syncing previous message..."
      });
      return;
    }
    
    Log.info('Index', '=== pushData START ===')
    Log.info('Index', 'Sending message:', data)
    Log.info('Index', 'connectedDeviceId:', this.connectedDeviceId)
    Log.info('Index', 'remoteConnectDeviceId:', this.remoteConnectDeviceId)
    Log.info('Index', 'Current messageList length:', this.messageList.length)
    Log.info('Index', 'Current allMessages length:', this.allMessages.length)
    
    // Ê£ÄÊü•ËøûÊé•Áä∂ÊÄÅ
    if (!this.remoteConnectDeviceId) {
      Log.error('Index', 'No remote device connected!')
      this.getUIContext().getPromptAction().showToast({
        message: "Device not connected!"
      });
      return;
    }
    
    this.messageList.push(data)
    Log.info('Index', 'Added to messageList, new length:', this.messageList.length)
    Log.info('Index', 'All messages in messageList:', JSON.stringify(this.messageList))
    
    // Ê∑ªÂä†Âà∞ÂêàÂπ∂Ê∂àÊÅØÂàóË°®Ôºà‰ΩøÁî®ÁúüÂÆûÊó∂Èó¥Êà≥Ôºâ
    const timestamp = Date.now()
    this.allMessages.push({
      content: data,
      isSent: true,
      timestamp: timestamp
    })
    Log.info('Index', `Added to allMessages with timestamp ${timestamp}, new length: ${this.allMessages.length}`)
    
    // ÊåâÊó∂Èó¥ÊéíÂ∫è
    this.allMessages.sort((a, b) => a.timestamp - b.timestamp)
    
    // ‰ΩøÁî®ÂåÖÂê´Êú¨Âú∞ networkId ÁöÑÂîØ‰∏Ä keyÔºåËøôÊ†∑ÂØπÊñπÂèØ‰ª•ËØÜÂà´Ê∂àÊÅØÊù•Ê∫ê
    // ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÊú¨Âú∞ÂêØÂä®ÁöÑËÆæÂ§áÔºàÂèëËµ∑ËøûÊé•ÁöÑÔºâ‰ΩøÁî® sender key
    // ËøúÁ®ãÂêØÂä®ÁöÑËÆæÂ§áÔºàË¢´ËøûÊé•ÁöÑÔºâ‰ΩøÁî® receiver key
    const messageKey = 'messages_' + (this.isReceiver ? 'receiver' : 'sender')
    Log.info('Index', 'Using key:', messageKey)
    Log.info('Index', 'isReceiver:', this.isReceiver, 'isSender:', this.isSender)
    
    this.isSyncing = true
    Log.info('Index', 'Set isSyncing = true')
    
    this.kvStoreModel.put(messageKey, JSON.stringify(this.messageList), this.remoteConnectDeviceId, (success: boolean) => {
      Log.info('Index', 'Sync callback received, success:', success)
      Log.info('Index', 'Setting isSyncing = false')
      this.isSyncing = false
      Log.info('Index', 'isSyncing is now:', this.isSyncing)
      
      if (success) {
        Log.info('Index', 'Message synced successfully')
        Log.info('Index', '=== pushData END (success) ===')
      } else {
        Log.error('Index', 'Message sync failed, will retry...')
        
        // ÈáçËØï‰∏ÄÊ¨°
        setTimeout(() => {
          this.kvStoreModel.put(messageKey, JSON.stringify(this.messageList), this.remoteConnectDeviceId, (retrySuccess: boolean) => {
            if (!retrySuccess) {
              this.getUIContext().getPromptAction().showToast({
                message: "Sync failed! Check connection."
              });
            }
          });
        }, 500);
      }
    })
    
    this.textInput = ''  // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
    Log.info('Index', 'Cleared textInput, new value:', this.textInput)
    
    // Âª∂ËøüÊªöÂä®Âà∞Â∫ïÈÉ®ÔºåÁ≠âÂæÖUIÊõ¥Êñ∞
    setTimeout(() => {
      this.scroller.scrollEdge(Edge.Bottom)
    }, 100)
  }

  // Êõ¥Êñ∞ÂêàÂπ∂Ê∂àÊÅØÂàóË°®ÔºàÂ¢ûÈáèÊ∑ªÂä†Êñ∞Êé•Êî∂ÁöÑÊ∂àÊÅØÔºâ
  updateAllMessages(): void {
    Log.info('Index', 'updateAllMessages called')
    Log.info('Index', '  - receivedList.length:', this.receivedList.length)
    Log.info('Index', '  - lastReceivedCount:', this.lastReceivedCount)
    Log.info('Index', '  - allMessages.length:', this.allMessages.length)
    
    // Âè™Â§ÑÁêÜÊñ∞Êé•Êî∂ÁöÑÊ∂àÊÅØ
    if (this.receivedList.length > this.lastReceivedCount) {
      Log.info('Index', `Processing ${this.receivedList.length - this.lastReceivedCount} new messages`)
      
      // Ê∑ªÂä†Êñ∞Ê∂àÊÅØÔºå‰ΩøÁî®ÂΩìÂâçÊó∂Èó¥ + Á¥¢ÂºïÂÅèÁßªÁ°Æ‰øùÈ°∫Â∫è
      const baseTime = Date.now()
      for (let i = this.lastReceivedCount; i < this.receivedList.length; i++) {
        const timestamp = baseTime + (i - this.lastReceivedCount)
        this.allMessages.push({
          content: this.receivedList[i],
          isSent: false,
          timestamp: timestamp
        })
        Log.info('Index', `Added received message [${i}]: "${this.receivedList[i]}" with timestamp ${timestamp}`)
      }
      
      // Êõ¥Êñ∞ËÆ°Êï∞
      this.lastReceivedCount = this.receivedList.length
      Log.info('Index', `Updated lastReceivedCount to ${this.lastReceivedCount}`)
      
      // ÊåâÊó∂Èó¥ÊéíÂ∫è
      this.allMessages.sort((a, b) => a.timestamp - b.timestamp)
      
      // ÊªöÂä®Âà∞Â∫ïÈÉ®
      setTimeout(() => {
        this.scroller.scrollEdge(Edge.Bottom)
      }, 100)
    } else {
      Log.info('Index', 'No new messages to process')
    }
  }

  @Builder
  MessageBubble(message: string, isSent: boolean) {
    Row() {
      if (isSent) {
        Blank()
      }
      
      // Ê∂àÊÅØÊ∞îÊ≥°ÂÆπÂô®
      Column() {
        Text(message)
          .fontSize(16)
          .fontColor(isSent ? Color.White : '#1C1C1E')
          .lineHeight(22)
          .wordBreak(WordBreak.BREAK_WORD)
          .textAlign(TextAlign.Start)
      }
      .padding({ left: 14, right: 14, top: 10, bottom: 10 })
      .constraintSize({ maxWidth: '75%' })  // ÊúÄÂ§ßÂÆΩÂ∫¶ 75%ÔºåËá™ÈÄÇÂ∫îÂÜÖÂÆπ
      .backgroundColor(isSent ? '#007AFF' : '#E9E9EB')
      .borderRadius(isSent ? { topLeft: 18, topRight: 18, bottomLeft: 18, bottomRight: 4 } : 
                              { topLeft: 18, topRight: 18, bottomLeft: 4, bottomRight: 18 })
      .shadow({ 
        radius: 8, 
        color: isSent ? '#007AFF20' : '#00000010', 
        offsetX: 0, 
        offsetY: 2 
      })
      
      if (!isSent) {
        Blank()
      }
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 6, bottom: 6 })
    .justifyContent(isSent ? FlexAlign.End : FlexAlign.Start)
  }

  startAbility(
    context: common.UIAbilityContext,
    device: distributedDeviceManager.DeviceBasicInfo,
    shared_list: string[]
  ): void {
    DeviceManager.authenticateDevice(context, device, shared_list)
    DeviceManager.stopDeviceDiscovery()
  }

  build() {
    Column() {
      // È°∂ÈÉ®ÂØºËà™Ê†è
      Row() {
        Column() {
          Text(this.isPaired ? 'Chat Room' : 'Not Connected')
            .fontSize(17)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1C1C1E')
          
          if (this.isPaired) {
            Text('Connected & Syncing')
              .fontSize(12)
              .fontColor('#34C759')
              .margin({ top: 2 })
          }
        }
        .alignItems(HorizontalAlign.Start)
        
        Blank()
        
        Button({ type: ButtonType.Normal }) {
          Text('üîç')
            .fontSize(22)
        }
        .width(44)
        .height(44)
        .borderRadius(22)
        .backgroundColor('#F2F2F7')
        .onClick(() => {
          this.startFindingNearbyDevice()
          this.dialogController.open()
        })
        
        if (this.isPaired && this.remoteConnectDeviceId !== '') {
          Button({ type: ButtonType.Normal }) {
            Text('‚úï')
              .fontSize(22)
              .fontColor('#FF3B30')
              .fontWeight(FontWeight.Medium)
          }
          .width(44)
          .height(44)
          .borderRadius(22)
          .backgroundColor('#F2F2F7')
          .margin({ left: 10 })
          .onClick(() => {
            this.getUIContext().getPromptAction().showToast({
              message: "Disconnecting..."
            })
            setTimeout(() => {
              DeviceManager.unbindDevice(this.connectedDeviceId)
              this.connectedDeviceId = ''
              this.remoteConnectDeviceId = ''
              this.messageList = []
              this.receivedList = []
            }, 100)
          })
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 14, bottom: 14 })
      .backgroundColor('#FFFFFF')
      .shadow({ radius: 3, color: '#00000008', offsetY: 1 })

      // ËøûÊé•Áä∂ÊÄÅ‰ø°ÊÅØ
      if (this.isPaired) {
        Row() {
          Row() {
            Text('‚óè')
              .fontSize(10)
              .fontColor('#34C759')
              .margin({ right: 6 })
            
            Text('Online')
              .fontSize(13)
              .fontColor('#34C759')
              .fontWeight(FontWeight.Medium)
          }
          
          Blank()
          
          Text(`ID: ${this.remoteConnectDeviceId.substring(0, 12)}...`)
            .fontSize(12)
            .fontColor('#8E8E93')
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 10, bottom: 10 })
        .backgroundColor('#F8F8F8')
      }

      // Ê∂àÊÅØÂàóË°®Âå∫Âüü
      List({ space: 8, scroller: this.scroller }) {
        // ÊòæÁ§∫ÊâÄÊúâÊ∂àÊÅØÔºàÊåâÊó∂Èó¥ÊéíÂ∫èÔºâ
        ForEach(this.allMessages, (item: ChatMessage, index: number) => {
          ListItem() {
            this.MessageBubble(item.content, item.isSent)
          }
        }, (item: ChatMessage, index: number) => `msg_${index}_${item.timestamp}`)
      }
      .layoutWeight(1)
      .width('100%')
      .backgroundColor('#F5F5F5')
      .padding({ top: 8, bottom: 8 })
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring)

      // Â∫ïÈÉ®ËæìÂÖ•Âå∫Âüü
      Row() {
        TextInput({ 
          text: this.textInput, 
          placeholder: 'üí¨ Type a message...' 
        })
        .layoutWeight(1)
        .height(44)
        .borderRadius(22)
        .backgroundColor('#FFFFFF')
        .padding({ left: 18, right: 18 })
        .fontSize(16)
        .placeholderColor('#AEAEB2')
        .border({ width: 1, color: '#E5E5EA' })
        .onChange((value: string) => {
          this.textInput = value
          Log.info('Index', 'TextInput onChange, new value:', value)
        })
        .onSubmit(() => {
          if ((!this.connectedDeviceId && !this.remoteConnectDeviceId) || !this.textInput) {
            this.getUIContext().getPromptAction().showToast({
              message: "No device connected or empty message"
            })
            return
          }
          if (this.textInput) {
            this.pushData(this.textInput)
          }
        })

        Button({ type: ButtonType.Circle }) {
          if (this.isSyncing) {
            LoadingProgress()
              .width(22)
              .height(22)
              .color(Color.White)
          } else {
            Text('‚û§')
              .fontSize(22)
              .fontColor(Color.White)
              .fontWeight(FontWeight.Bold)
          }
        }
        .width(44)
        .height(44)
        .margin({ left: 10 })
        .backgroundColor(this.textInput && !this.isSyncing ? '#007AFF' : '#C7C7CC')
        .shadow({ 
          radius: 8, 
          color: this.textInput && !this.isSyncing ? '#007AFF30' : '#00000010', 
          offsetY: 2 
        })
        .enabled(!!this.textInput && !this.isSyncing)
        .onClick(() => {
          Log.info('Index', '=== Send button clicked ===')
          Log.info('Index', 'textInput:', this.textInput)
          Log.info('Index', 'isSyncing:', this.isSyncing)
          Log.info('Index', 'connectedDeviceId:', this.connectedDeviceId)
          Log.info('Index', 'remoteConnectDeviceId:', this.remoteConnectDeviceId)
          
          if ((!this.connectedDeviceId && !this.remoteConnectDeviceId) || !this.textInput) {
            Log.info('Index', 'Validation failed')
            this.getUIContext().getPromptAction().showToast({
              message: "No device connected or empty message"
            })
            return
          }

          if (this.textInput) {
            this.pushData(this.textInput)
          }
        })
      }
      .width('100%')
      .padding({ left: 14, right: 14, top: 10, bottom: 10 })
      .backgroundColor('#FFFFFF')
      .borderRadius({ topLeft: 16, topRight: 16 })
      .shadow({ radius: 4, color: '#00000008', offsetY: -2 })

    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFF')
  }
}